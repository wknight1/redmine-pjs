services:
  # ============================================================================
  # PostgreSQL 18.1 (한글 로케일 + 성능 튜닝)
  # ============================================================================
  db:
    build:
      context: .
      dockerfile: Dockerfile
      target: database
    
    environment:
      POSTGRES_USER: redmine
      POSTGRES_DB: redmine
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      TZ: Asia/Seoul
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --locale=ko_KR.UTF-8 --lc-collate=ko_KR.UTF-8 --lc-ctype=ko_KR.UTF-8"
    
    command:
      - "postgres"
      - "-c"
      - "shared_buffers=512MB"
      - "-c"
      - "max_connections=200"
      - "-c"
      - "effective_cache_size=1GB"
      - "-c"
      - "maintenance_work_mem=128MB"
      - "-c"
      - "checkpoint_completion_target=0.9"
      - "-c"
      - "wal_buffers=16MB"
      - "-c"
      - "default_statistics_target=100"
      - "-c"
      - "random_page_cost=1.1"
      - "-c"
      - "effective_io_concurrency=200"
      - "-c"
      - "work_mem=5242kB"
      - "-c"
      - "min_wal_size=1GB"
      - "-c"
      - "max_wal_size=4GB"
      - "-c"
      - "log_statement=mod"
      - "-c"
      - "log_min_duration_statement=1000"
    
    volumes:
      - db_data:/var/lib/postgresql/data
    
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U redmine -d redmine"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s
    
    restart: unless-stopped
    
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    
    networks:
      - redmine_network

  # ============================================================================
  # Redmine 6.1.1 (한국어 최적화 + 프로덕션 강화)
  # ============================================================================
  redmine:
    build:
      context: .
      dockerfile: Dockerfile
      target: application
    
    environment:
      REDMINE_DB_POSTGRES: db
      REDMINE_DB_DATABASE: redmine
      REDMINE_DB_USERNAME: redmine
      REDMINE_DB_PASSWORD: ${DB_PASSWORD}
      REDMINE_DB_ENCODING: utf8
      DB_POOL: "20"
      REDMINE_SECRET_KEY_BASE: ${REDMINE_SECRET_KEY_BASE}
      SECRET_KEY_BASE: ${REDMINE_SECRET_KEY_BASE}
      RAILS_ENV: production
      RAILS_LOG_TO_STDOUT: "1"
      RAILS_SERVE_STATIC_FILES: "true"
      LANG: ko_KR.UTF-8
      LC_ALL: ko_KR.UTF-8
      TZ: Asia/Seoul
      REDMINE_LANG: ko
      RAILS_MAX_THREADS: "5"
      WEB_CONCURRENCY: "4"
      MALLOC_ARENA_MAX: "2"
      RUBY_GC_HEAP_GROWTH_FACTOR: "1.1"
      RUBY_GC_MALLOC_LIMIT: "16000000"
      RUBY_GC_OLDMALLOC_LIMIT: "16000000"
    
    volumes:
      - redmine_files:/usr/src/redmine/files
      - redmine_plugins:/usr/src/redmine/plugins
      - redmine_themes:/usr/src/redmine/public/themes
      - redmine_logs:/usr/src/redmine/log
      - redmine_tmp:/usr/src/redmine/tmp
      - redmine_assets:/usr/src/redmine/public/assets
    
    ports:
      - "3000:3000"
    
    depends_on:
      db:
        condition: service_healthy
    
    healthcheck:
      test: ["CMD-SHELL", "/healthcheck.sh"]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 180s
    
    restart: unless-stopped
    
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 1G
    
    networks:
      - redmine_network

networks:
  redmine_network:
    driver: bridge

volumes:
  db_data:
    driver: local
  redmine_files:
    driver: local
  redmine_plugins:
    driver: local
  redmine_themes:
    driver: local
  redmine_logs:
    driver: local
  redmine_tmp:
    driver: local
  redmine_assets:
    driver: local
